<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .login-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-lg);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo h1 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .success-message {
            color: var(--success);
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* Admin Panel Layout */
        .admin-panel {
            display: none;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: white;
            border-right: 1px solid var(--border);
            padding: 24px 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h2 {
            font-size: 20px;
            color: var(--primary);
        }

        .sidebar-nav {
            padding: 24px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-main);
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--bg-main);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        .main-content {
            margin-left: 260px;
            padding: 32px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 28px;
            color: var(--text-primary);
        }

        .header-actions button {
            padding: 10px 20px;
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .stat-card.success {
            border-left-color: var(--success);
        }

        .stat-card.danger {
            border-left-color: var(--danger);
        }

        .stat-card.warning {
            border-left-color: var(--warning);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        .card-header h3 {
            font-size: 18px;
            color: var(--text-primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-main);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tr:hover {
            background: var(--bg-main);
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        /* Student Info Card */
        .student-info-card {
            background: var(--bg-main);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 24px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-bar button {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-bar button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Section */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Print Bill */
        .print-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .print-overlay.active {
            display: flex;
        }

        .print-bill {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .print-header {
            text-align: center;
            border-bottom: 2px solid var(--border);
            padding-bottom: 20px;
            margin-bottom: 24px;
        }

        .print-header h2 {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .print-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .print-actions button {
            flex: 1;
            padding: 12px;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-bill, .print-bill * {
                visibility: visible;
            }
            .print-bill {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .print-actions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <h1>üìö Library Management</h1>
                <p>Admin Login</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="admin@library.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p class="error-message" id="loginError"></p>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üìö Library Admin</h2>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" data-section="dashboard">
                    <span class="nav-icon">üìä</span>
                    Dashboard
                </div>
                <div class="nav-item" data-section="register">
                    <span class="nav-icon">‚ûï</span>
                    Register Student
                </div>
                <div class="nav-item" data-section="billing">
                    <span class="nav-icon">üí∞</span>
                    Billing
                </div>
                <div class="nav-item" data-section="history">
                    <span class="nav-icon">üìã</span>
                    Billing History
                </div>
            </div>
            <div class="sidebar-footer">
                <button class="btn btn-danger" id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="section active" id="dashboard">
                <div class="header">
                    <h1>Dashboard</h1>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Registered</div>
                        <div class="stat-value" id="totalStudents">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Active Students</div>
                        <div class="stat-value" id="activeStudents">0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">Total Pending Dues</div>
                        <div class="stat-value" id="totalDues">‚Çπ0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Registrations</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Mobile</th>
                                    <th>Shift</th>
                                    <th>Joining Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentStudents">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-secondary);">No recent registrations</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Register Section -->
            <div class="section" id="register">
                <div class="header">
                    <h1>Register New Student</h1>
                </div>

                <div class="card">
                    <form id="registerForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Student Name *</label>
                                <input type="text" id="studentName" placeholder="Enter full name" required>
                            </div>
                            <div class="form-group">
                                <label>Mobile Number *</label>
                                <input type="tel" id="studentMobile" placeholder="10-digit mobile" pattern="[0-9]{10}" required>
                            </div>
                            <div class="form-group">
                                <label>Select Shift *</label>
                                <select id="studentShift" required>
                                    <option value="">-- Select Shift --</option>
                                    <option value="Shift 1: 6 AM - 10 AM">Shift 1: 6 AM - 10 AM</option>
                                    <option value="Shift 2: 10 AM - 2 PM">Shift 2: 10 AM - 2 PM</option>
                                    <option value="Shift 3: 2 PM - 6 PM">Shift 3: 2 PM - 6 PM</option>
                                    <option value="Shift 4: 6 PM - 10 PM">Shift 4: 6 PM - 10 PM</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Joining Date</label>
                                <input type="text" id="joiningDate" readonly>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Register Student</button>
                        <p class="success-message" id="registerSuccess"></p>
                        <p class="error-message" id="registerError"></p>
                    </form>
                </div>
            </div>

            <!-- Billing Section -->
            <div class="section" id="billing">
                <div class="header">
                    <h1>Student Billing</h1>
                </div>

                <div class="card">
                    <div class="search-box">
                        <input type="tel" id="searchMobile" placeholder="Search by mobile number..." pattern="[0-9]{10}">
                    </div>
                    <button class="btn btn-primary" onclick="searchStudent()">Search Student</button>
                </div>

                <div id="studentInfoSection" style="display: none;">
                    <div class="student-info-card">
                        <h3 style="margin-bottom: 16px;">Student Information</h3>
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value" id="billStudentName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Mobile:</span>
                            <span class="info-value" id="billStudentMobile">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Shift:</span>
                            <span class="info-value" id="billStudentShift">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Monthly Fee:</span>
                            <span class="info-value" id="billMonthlyFee">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Joining Date:</span>
                            <span class="info-value" id="billJoiningDate">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Last Paid Till:</span>
                            <span class="info-value" id="billLastPaid">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Due Months:</span>
                            <span class="info-value" id="billDueMonths" style="color: var(--danger); font-weight: 700;">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Due Amount:</span>
                            <span class="info-value" id="billDueAmount" style="color: var(--danger); font-size: 20px; font-weight: 700;">-</span>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 16px;">Payment Options</h3>
                        <div class="form-group">
                            <label>Payment Amount</label>
                            <input type="number" id="paymentAmount" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label>Payment Mode</label>
                            <select id="paymentMode">
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI</option>
                                <option value="Card">Card</option>
                                <option value="Net Banking">Net Banking</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="processPayment()">Process Payment</button>
                        <button class="btn btn-primary" onclick="printBill()" style="margin-top: 12px;">Print Bill</button>
                        <p class="success-message" id="paymentSuccess"></p>
                        <p class="error-message" id="paymentError"></p>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="section" id="history">
                <div class="header">
                    <h1>Billing History</h1>
                </div>

                <div class="card">
                    <div class="filter-bar">
                        <button class="active" onclick="filterHistory('all')">All</button>
                        <button onclick="filterHistory('today')">Today</button>
                        <button onclick="filterHistory('month')">This Month</button>
                        <input type="date" id="filterFromDate" placeholder="From Date">
                        <input type="date" id="filterToDate" placeholder="To Date">
                        <button onclick="filterHistory('custom')">Apply Custom</button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Mobile</th>
                                    <th>Amount Paid</th>
                                    <th>Period</th>
                                    <th>Payment Date</th>
                                    <th>Mode</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--text-secondary);">No billing history</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Bill Overlay -->
    <div class="print-overlay" id="printOverlay">
        <div class="print-bill" id="printBillContent">
            <div class="print-header">
                <h2>üìö Library Management System</h2>
                <p>Payment Receipt</p>
            </div>
            <div id="printBillDetails"></div>
            <div class="print-actions">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print</button>
                <button class="btn btn-secondary" onclick="closePrintBill()">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc, query, where, orderBy, limit, Timestamp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAr8Zw8wmVETcwotsVGo7r7ZtcYFvGl-pg",
            authDomain: "purainiya-library.firebaseapp.com",
            projectId: "purainiya-library",
            storageBucket: "purainiya-library.firebasestorage.app",
            messagingSenderId: "885731486344",
            appId: "1:885731486344:web:01d234421bd5678831cd3d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.auth = auth;
        window.db = db;
        window.firebaseAuth = { signInWithEmailAndPassword, signOut, onAuthStateChanged };
        window.firebaseFirestore = { collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc, query, where, orderBy, limit, Timestamp };

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadDashboard();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminPanel').style.display = 'none';
            }
        });

        console.log('Firebase initialized successfully');
    </script>

    <script>
        // ===== UTILITY FUNCTIONS =====
        
        function formatDate(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function parseDate(dateStr) {
            // Parse DD/MM/YYYY format
            const parts = dateStr.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function getTodayDate() {
            return formatDate(new Date());
        }

        // ===== BILLING CALCULATION LOGIC =====
        // CRITICAL: Billing cycles are based on JOINING DATE, not payment date
        // Example: If joined 16/02/2026
        // - Cycle 1: 16 Feb - 15 Mar
        // - Cycle 2: 16 Mar - 15 Apr
        // - Cycle 3: 16 Apr - 15 May
        // Payment date (e.g., 18 Feb) does NOT change the cycle
        
        function calculateDueMonths(joiningDate, lastPaidTillDate) {
            const joining = parseDate(joiningDate);
            const lastPaid = parseDate(lastPaidTillDate);
            const today = new Date();
            
            // Calculate complete billing cycles from last paid date to today
            let months = (today.getFullYear() - lastPaid.getFullYear()) * 12;
            months += today.getMonth() - lastPaid.getMonth();
            
            // Check if current cycle is complete based on joining day
            const joiningDay = joining.getDate();
            const todayDay = today.getDate();
            
            // If today's day >= joining day, current cycle is complete
            if (todayDay >= joiningDay) {
                months += 1;
            }
            
            return Math.max(0, months);
        }

        function calculateNewLastPaidDate(currentLastPaidDate, monthsPaying, joiningDate) {
            const joining = parseDate(joiningDate);
            const joiningDay = joining.getDate();
            const lastPaid = parseDate(currentLastPaidDate);
            
            // Add months to last paid date, maintaining the joining day
            const newDate = new Date(lastPaid);
            newDate.setMonth(newDate.getMonth() + monthsPaying);
            
            // Ensure we maintain the joining day (handle month-end edge cases)
            const lastDayOfMonth = new Date(newDate.getFullYear(), newDate.getMonth() + 1, 0).getDate();
            const targetDay = Math.min(joiningDay, lastDayOfMonth);
            newDate.setDate(targetDay);
            
            return formatDate(newDate);
        }

        // ===== AUTHENTICATION =====
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorMsg = document.getElementById('loginError');
            
            try {
                await window.firebaseAuth.signInWithEmailAndPassword(window.auth, email, password);
                errorMsg.textContent = '';
            } catch (error) {
                errorMsg.textContent = 'Invalid email or password';
                console.error('Login error:', error);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await window.firebaseAuth.signOut(window.auth);
        });

        // ===== NAVIGATION =====
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                
                // Update active nav
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Show section
                document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                
                // Load data for specific sections
                if (section === 'dashboard') {
                    loadDashboard();
                } else if (section === 'history') {
                    loadHistory();
                }
            });
        });

        // ===== DASHBOARD =====
        
        async function loadDashboard() {
            try {
                const studentsRef = window.firebaseFirestore.collection(window.db, 'students');
                const snapshot = await window.firebaseFirestore.getDocs(studentsRef);
                
                let totalStudents = 0;
                let activeStudents = 0;
                let totalDues = 0;
                const recentStudents = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalStudents++;
                    
                    if (data.status === 'Active') {
                        activeStudents++;
                    }
                    
                    // Calculate current dues
                    const dueMonths = calculateDueMonths(data.joining_date, data.last_paid_till_date);
                    const dueAmount = dueMonths * data.monthly_fee;
                    totalDues += dueAmount;
                    
                    recentStudents.push({
                        ...data,
                        id: doc.id
                    });
                });
                
                // Update stats
                document.getElementById('totalStudents').textContent = totalStudents;
                document.getElementById('activeStudents').textContent = activeStudents;
                document.getElementById('totalDues').textContent = `‚Çπ${totalDues.toLocaleString()}`;
                
                // Sort by joining date (most recent first) and take top 5
                recentStudents.sort((a, b) => {
                    return parseDate(b.joining_date) - parseDate(a.joining_date);
                });
                
                const top5 = recentStudents.slice(0, 5);
                
                // Update recent registrations table
                const tbody = document.getElementById('recentStudents');
                if (top5.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No recent registrations</td></tr>';
                } else {
                    tbody.innerHTML = top5.map(student => `
                        <tr>
                            <td>${student.name}</td>
                            <td>${student.mobile}</td>
                            <td>${student.shift}</td>
                            <td>${student.joining_date}</td>
                            <td><span class="badge badge-success">${student.status}</span></td>
                        </tr>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // ===== STUDENT REGISTRATION =====
        
        // Set today's date in joining date field
        document.getElementById('joiningDate').value = getTodayDate();

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('studentName').value;
            const mobile = document.getElementById('studentMobile').value;
            const shift = document.getElementById('studentShift').value;
            const joiningDate = getTodayDate();
            const monthlyFee = 500; // ‚Çπ500 per shift
            
            const successMsg = document.getElementById('registerSuccess');
            const errorMsg = document.getElementById('registerError');
            
            try {
                // Check if mobile already exists
                const studentsRef = window.firebaseFirestore.collection(window.db, 'students');
                const q = window.firebaseFirestore.query(studentsRef, window.firebaseFirestore.where('mobile', '==', mobile));
                const querySnapshot = await window.firebaseFirestore.getDocs(q);
                
                if (!querySnapshot.empty) {
                    errorMsg.textContent = 'Student with this mobile number already exists!';
                    successMsg.textContent = '';
                    return;
                }
                
                // Add new student
                const studentData = {
                    name: name,
                    mobile: mobile,
                    shift: shift,
                    monthly_fee: monthlyFee,
                    joining_date: joiningDate,
                    last_paid_till_date: joiningDate, // Initially set to joining date
                    total_paid: 0,
                    total_due: 0,
                    status: 'Active',
                    created_at: window.firebaseFirestore.Timestamp.now()
                };
                
                await window.firebaseFirestore.addDoc(studentsRef, studentData);
                
                // Success
                successMsg.textContent = 'Student registered successfully!';
                errorMsg.textContent = '';
                
                // Clear form
                document.getElementById('registerForm').reset();
                document.getElementById('joiningDate').value = getTodayDate();
                
                // Refresh dashboard
                loadDashboard();
                
                setTimeout(() => {
                    successMsg.textContent = '';
                }, 3000);
                
            } catch (error) {
                errorMsg.textContent = 'Error registering student. Please try again.';
                successMsg.textContent = '';
                console.error('Registration error:', error);
            }
        });

        // ===== BILLING =====
        
        let currentStudent = null;

        async function searchStudent() {
            const mobile = document.getElementById('searchMobile').value;
            
            if (!mobile || mobile.length !== 10) {
                alert('Please enter a valid 10-digit mobile number');
                return;
            }
            
            try {
                const studentsRef = window.firebaseFirestore.collection(window.db, 'students');
                const q = window.firebaseFirestore.query(studentsRef, window.firebaseFirestore.where('mobile', '==', mobile));
                const querySnapshot = await window.firebaseFirestore.getDocs(q);
                
                if (querySnapshot.empty) {
                    alert('Student not found with this mobile number');
                    document.getElementById('studentInfoSection').style.display = 'none';
                    return;
                }
                
                // Get student data
                const studentDoc = querySnapshot.docs[0];
                currentStudent = {
                    id: studentDoc.id,
                    ...studentDoc.data()
                };
                
                // Calculate dues
                const dueMonths = calculateDueMonths(currentStudent.joining_date, currentStudent.last_paid_till_date);
                const dueAmount = dueMonths * currentStudent.monthly_fee;
                
                // Update UI
                document.getElementById('billStudentName').textContent = currentStudent.name;
                document.getElementById('billStudentMobile').textContent = currentStudent.mobile;
                document.getElementById('billStudentShift').textContent = currentStudent.shift;
                document.getElementById('billMonthlyFee').textContent = `‚Çπ${currentStudent.monthly_fee}`;
                document.getElementById('billJoiningDate').textContent = currentStudent.joining_date;
                document.getElementById('billLastPaid').textContent = currentStudent.last_paid_till_date;
                document.getElementById('billDueMonths').textContent = `${dueMonths} month${dueMonths !== 1 ? 's' : ''}`;
                document.getElementById('billDueAmount').textContent = `‚Çπ${dueAmount.toLocaleString()}`;
                
                // Set payment amount to full due
                document.getElementById('paymentAmount').value = dueAmount;
                
                // Show billing section
                document.getElementById('studentInfoSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error searching student:', error);
                alert('Error searching student. Please try again.');
            }
        }

        async function processPayment() {
            if (!currentStudent) {
                alert('Please search for a student first');
                return;
            }
            
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentMode = document.getElementById('paymentMode').value;
            const successMsg = document.getElementById('paymentSuccess');
            const errorMsg = document.getElementById('paymentError');
            
            if (!paymentAmount || paymentAmount <= 0) {
                errorMsg.textContent = 'Please enter a valid payment amount';
                successMsg.textContent = '';
                return;
            }
            
            try {
                // Calculate how many months this payment covers
                const monthsPaying = Math.floor(paymentAmount / currentStudent.monthly_fee);
                
                if (monthsPaying === 0) {
                    errorMsg.textContent = 'Payment amount is less than monthly fee';
                    successMsg.textContent = '';
                    return;
                }
                
                // Calculate new last_paid_till_date
                const newLastPaidDate = calculateNewLastPaidDate(
                    currentStudent.last_paid_till_date,
                    monthsPaying,
                    currentStudent.joining_date
                );
                
                // Update student record
                const studentRef = window.firebaseFirestore.doc(window.db, 'students', currentStudent.id);
                await window.firebaseFirestore.updateDoc(studentRef, {
                    last_paid_till_date: newLastPaidDate,
                    total_paid: (currentStudent.total_paid || 0) + paymentAmount,
                    total_due: Math.max(0, (currentStudent.total_due || 0) - paymentAmount)
                });
                
                // Add to billing history
                const historyData = {
                    student_id: currentStudent.id,
                    name: currentStudent.name,
                    mobile: currentStudent.mobile,
                    amount_paid: paymentAmount,
                    period_from: currentStudent.last_paid_till_date,
                    period_to: newLastPaidDate,
                    payment_date: getTodayDate(),
                    payment_mode: paymentMode,
                    created_at: window.firebaseFirestore.Timestamp.now()
                };
                
                await window.firebaseFirestore.addDoc(
                    window.firebaseFirestore.collection(window.db, 'billing_history'),
                    historyData
                );
                
                // Success
                successMsg.textContent = `Payment of ‚Çπ${paymentAmount} processed successfully!`;
                errorMsg.textContent = '';
                
                // Refresh student data
                await searchStudent();
                
                // Refresh dashboard
                loadDashboard();
                
                setTimeout(() => {
                    successMsg.textContent = '';
                }, 3000);
                
            } catch (error) {
                errorMsg.textContent = 'Error processing payment. Please try again.';
                successMsg.textContent = '';
                console.error('Payment error:', error);
            }
        }

        function printBill() {
            if (!currentStudent) {
                alert('Please search for a student first');
                return;
            }
            
            const dueMonths = calculateDueMonths(currentStudent.joining_date, currentStudent.last_paid_till_date);
            const dueAmount = dueMonths * currentStudent.monthly_fee;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || dueAmount;
            const monthsPaying = Math.floor(paymentAmount / currentStudent.monthly_fee);
            const newLastPaidDate = calculateNewLastPaidDate(
                currentStudent.last_paid_till_date,
                monthsPaying,
                currentStudent.joining_date
            );
            
            const billHTML = `
                <div style="margin: 20px 0;">
                    <h3 style="margin-bottom: 16px; color: var(--primary);">Student Details</h3>
                    <div style="background: var(--bg-main); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 8px 0;"><strong>Name:</strong> ${currentStudent.name}</p>
                        <p style="margin: 8px 0;"><strong>Mobile:</strong> ${currentStudent.mobile}</p>
                        <p style="margin: 8px 0;"><strong>Shift:</strong> ${currentStudent.shift}</p>
                        <p style="margin: 8px 0;"><strong>Joining Date:</strong> ${currentStudent.joining_date}</p>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; color: var(--primary);">Payment Details</h3>
                    <div style="background: var(--bg-main); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 8px 0;"><strong>Monthly Fee:</strong> ‚Çπ${currentStudent.monthly_fee}</p>
                        <p style="margin: 8px 0;"><strong>Due Months:</strong> ${dueMonths}</p>
                        <p style="margin: 8px 0;"><strong>Total Due:</strong> ‚Çπ${dueAmount.toLocaleString()}</p>
                        <p style="margin: 8px 0;"><strong>Amount Paying:</strong> ‚Çπ${paymentAmount.toLocaleString()}</p>
                        <p style="margin: 8px 0;"><strong>Period:</strong> ${currentStudent.last_paid_till_date} to ${newLastPaidDate}</p>
                        <p style="margin: 8px 0;"><strong>Payment Date:</strong> ${getTodayDate()}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border);">
                        <p style="color: var(--text-secondary); font-size: 14px;">Thank you for your payment!</p>
                    </div>
                </div>
            `;
            
            document.getElementById('printBillDetails').innerHTML = billHTML;
            document.getElementById('printOverlay').classList.add('active');
        }

        function closePrintBill() {
            document.getElementById('printOverlay').classList.remove('active');
        }

        // ===== BILLING HISTORY =====
        
        let historyData = [];
        let currentFilter = 'all';

        async function loadHistory() {
            try {
                const historyRef = window.firebaseFirestore.collection(window.db, 'billing_history');
                const q = window.firebaseFirestore.query(
                    historyRef,
                    window.firebaseFirestore.orderBy('created_at', 'desc')
                );
                const snapshot = await window.firebaseFirestore.getDocs(q);
                
                historyData = [];
                snapshot.forEach(doc => {
                    historyData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                filterHistory('all');
                
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function filterHistory(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-bar button').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target?.classList.add('active');
            
            let filtered = [...historyData];
            const today = new Date();
            
            if (filter === 'today') {
                const todayStr = getTodayDate();
                filtered = filtered.filter(item => item.payment_date === todayStr);
            } else if (filter === 'month') {
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                filtered = filtered.filter(item => {
                    const itemDate = parseDate(item.payment_date);
                    return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
                });
            } else if (filter === 'custom') {
                const fromDate = document.getElementById('filterFromDate').value;
                const toDate = document.getElementById('filterToDate').value;
                
                if (!fromDate || !toDate) {
                    alert('Please select both from and to dates');
                    return;
                }
                
                const from = new Date(fromDate);
                const to = new Date(toDate);
                
                filtered = filtered.filter(item => {
                    const itemDate = parseDate(item.payment_date);
                    return itemDate >= from && itemDate <= to;
                });
            }
            
            // Update table
            const tbody = document.getElementById('historyTable');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No billing history</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.mobile}</td>
                        <td><strong>‚Çπ${item.amount_paid.toLocaleString()}</strong></td>
                        <td>${item.period_from} to ${item.period_to}</td>
                        <td>${item.payment_date}</td>
                        <td><span class="badge badge-success">${item.payment_mode}</span></td>
                    </tr>
                `).join('');
            }
        }

        // Make functions globally available
        window.searchStudent = searchStudent;
        window.processPayment = processPayment;
        window.printBill = printBill;
        window.closePrintBill = closePrintBill;
        window.filterHistory = filterHistory;
    </script>
</body>
</html>